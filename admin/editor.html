<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Editor - KSA Malta CMS</title>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <!-- GrapesJS -->
    <link rel="stylesheet" href="https://unpkg.com/grapesjs/dist/css/grapes.min.css">
    <script src="https://unpkg.com/grapesjs"></script>
    <script src="https://unpkg.com/grapesjs-preset-webpage"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=IBM+Plex+Sans+Arabic:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            overflow: hidden;
        }

        /* Top Bar */
        .top-bar {
            height: 60px;
            background: #1a365d;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .top-bar-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .top-bar h1 {
            font-size: 16px;
            font-weight: 600;
        }
        .page-title {
            font-size: 14px;
            opacity: 0.8;
        }
        .top-bar-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .btn:hover {
            opacity: 0.9;
        }
        .btn-back {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        .btn-save {
            background: #d4a853;
            color: #1a365d;
        }
        .btn-preview {
            background: white;
            color: #1a365d;
        }
        .btn-publish {
            background: #28a745;
            color: white;
        }

        /* Main Layout */
        .main-layout {
            display: flex;
            height: calc(100vh - 60px);
        }

        /* Editor Container */
        #gjs {
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 300px;
            background: #f8f9fa;
            border-left: 1px solid #e9ecef;
            overflow-y: auto;
        }
        .sidebar-section {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }
        .sidebar-section h3 {
            font-size: 14px;
            font-weight: 600;
            color: #1a365d;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .version-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid #e9ecef;
        }
        .version-date {
            font-size: 12px;
            font-weight: 600;
            color: #1a365d;
        }
        .version-by {
            font-size: 11px;
            color: #6c757d;
            margin-top: 2px;
        }
        .version-note {
            font-size: 12px;
            color: #495057;
            margin-top: 4px;
            font-style: italic;
        }
        .btn-restore {
            margin-top: 8px;
            padding: 6px 12px;
            background: #1a365d;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            width: 100%;
        }
        .btn-restore:hover {
            background: #2c5282;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            display: none;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .notification.success {
            background: #28a745;
            color: white;
        }
        .notification.error {
            background: #dc3545;
            color: white;
        }
        .notification.info {
            background: #17a2b8;
            color: white;
        }

        /* GrapesJS Custom Styles */
        .gjs-one-bg {
            background-color: #1a365d;
        }
        .gjs-two-color {
            color: #1a365d;
        }
        .gjs-three-bg {
            background-color: #d4a853;
            color: #1a365d;
        }
        .gjs-four-color,
        .gjs-four-color-h:hover {
            color: #d4a853;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            .top-bar-right .btn {
                padding: 6px 12px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <div class="top-bar-left">
            <a href="/admin/index.html" class="btn btn-back">‚Üê Dashboard</a>
            <h1>Visual Editor</h1>
            <span class="page-title" id="page-title">Loading...</span>
        </div>
        <div class="top-bar-right">
            <button class="btn btn-save" id="btn-save-draft" onclick="saveDraft()">üíæ Save Draft</button>
            <button class="btn btn-preview" id="btn-preview" onclick="previewPage()">üëÅÔ∏è Preview</button>
            <button class="btn btn-publish" id="btn-publish" onclick="publishPage()">üöÄ Publish</button>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="main-layout">
        <!-- GrapesJS Editor -->
        <div id="gjs"></div>

        <!-- Sidebar: Version History -->
        <div class="sidebar">
            <div class="sidebar-section">
                <h3>Version History</h3>
                <div id="version-history">
                    <p style="font-size: 13px; color: #6c757d;">Loading versions...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <script src="js/firebase-config.js"></script>
    <script>
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        let currentUser = null;
        let currentUserRole = null;
        let pageSlug = '';
        let editor = null;

        // Get page slug from URL
        const urlParams = new URLSearchParams(window.location.search);
        pageSlug = urlParams.get('page') || 'home';

        // Auth check
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = '/admin/login.html';
                return;
            }

            try {
                const token = await user.getIdTokenResult();
                if (!token.claims.role || !['admin', 'super_admin', 'editor'].includes(token.claims.role)) {
                    await auth.signOut();
                    window.location.href = '/admin/login.html';
                    return;
                }

                currentUser = user;
                currentUserRole = token.claims.role;

                // Initialize editor
                initializeEditor();
                loadPageData();
                loadVersionHistory();

            } catch (error) {
                console.error('Auth error:', error);
                window.location.href = '/admin/login.html';
            }
        });

        // Initialize GrapesJS Editor
        function initializeEditor() {
            editor = grapesjs.init({
                container: '#gjs',
                height: '100%',
                width: '100%',
                fromElement: false,
                storageManager: false,
                plugins: ['gjs-preset-webpage'],
                pluginsOpts: {
                    'gjs-preset-webpage': {
                        blocksBasicOpts: {
                            blocks: ['column1', 'column2', 'column3', 'text', 'link', 'image', 'video', 'map'],
                            flexGrid: true,
                        },
                        blocks: ['link-block', 'quote', 'text-basic'],
                    }
                },
                canvas: {
                    styles: [
                        'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap',
                        'https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;500;600;700&display=swap'
                    ]
                },
                assetManager: {
                    upload: 'https://firebasestorage.googleapis.com',
                    uploadFile: async function(e) {
                        const files = e.dataTransfer ? e.dataTransfer.files : e.target.files;
                        const file = files[0];

                        if (!file) return;

                        try {
                            const storageRef = storage.ref(`cms-assets/${Date.now()}_${file.name}`);
                            const snapshot = await storageRef.put(file);
                            const url = await snapshot.ref.getDownloadURL();

                            editor.AssetManager.add({ src: url });
                            showNotification('Image uploaded successfully!', 'success');
                        } catch (error) {
                            console.error('Upload error:', error);
                            showNotification('Error uploading image: ' + error.message, 'error');
                        }
                    }
                },
                deviceManager: {
                    devices: [
                        { name: 'Desktop', width: '' },
                        { name: 'Tablet', width: '768px', widthMedia: '992px' },
                        { name: 'Mobile', width: '320px', widthMedia: '480px' }
                    ]
                }
            });

            // Add custom blocks
            addCustomBlocks();

            // Add custom styles
            addCustomStyles();

            // Keyboard shortcuts
            editor.on('run:preview', () => previewPage());

            // Auto-save on change (debounced)
            let autoSaveTimeout;
            editor.on('change:changesCount', () => {
                clearTimeout(autoSaveTimeout);
                autoSaveTimeout = setTimeout(() => {
                    console.log('Auto-saving...');
                    // Uncomment to enable auto-save
                    // saveDraft(true);
                }, 30000); // Auto-save every 30 seconds
            });
        }

        // Add custom KSA Malta blocks
        function addCustomBlocks() {
            const blockManager = editor.BlockManager;

            // Hero Banner
            blockManager.add('hero-banner', {
                label: 'Hero Banner',
                category: 'KSA Malta',
                content: `
                    <section class="hero-banner" style="position:relative; min-height:500px; background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%); display:flex; align-items:center; justify-content:center; padding: 40px 20px;">
                        <div style="text-align:center; color:white; max-width:800px;">
                            <h1 style="font-size:48px; font-weight:700; margin-bottom:16px; line-height: 1.2;">Welcome to Malta</h1>
                            <p style="font-size:20px; margin-bottom:32px; opacity:0.95; line-height: 1.6;">Your guide to studying and living in Malta</p>
                            <a href="#" style="display:inline-block; padding:16px 32px; background:#d4a853; color:#1a365d; font-weight:600; border-radius:8px; text-decoration:none; transition: transform 0.2s;">Get Started</a>
                        </div>
                    </section>
                `,
                media: '<svg style="width:48px;height:48px" viewBox="0 0 24 24"><path fill="currentColor" d="M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg>'
            });

            // Event Card
            blockManager.add('event-card', {
                label: 'Event Card',
                category: 'KSA Malta',
                content: `
                    <div style="background:white; border-radius:12px; overflow:hidden; box-shadow:0 4px 6px rgba(0,0,0,0.1); max-width:350px; margin: 20px;">
                        <div style="background:#1a365d; color:white; padding:16px; text-align:center;">
                            <span style="display:block; font-size:14px; text-transform:uppercase; letter-spacing: 1px;">March</span>
                            <span style="display:block; font-size:36px; font-weight:700;">15</span>
                        </div>
                        <div style="padding:24px;">
                            <h3 style="font-size:20px; font-weight:600; margin-bottom:8px; color:#1a365d;">Event Title</h3>
                            <p style="color:#6c757d; font-size:14px; margin-bottom:16px; line-height: 1.6;">
                                üìç Location: Malta Campus<br>
                                üïê Time: 6:00 PM
                            </p>
                            <a href="#" style="display:inline-block; padding:12px 24px; background:#d4a853; color:#1a365d; font-weight:500; border-radius:6px; text-decoration:none;">Register Now</a>
                        </div>
                    </div>
                `,
                media: '<svg style="width:48px;height:48px" viewBox="0 0 24 24"><path fill="currentColor" d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10z"/></svg>'
            });

            // Contact Card
            blockManager.add('contact-card', {
                label: 'Contact Card',
                category: 'KSA Malta',
                content: `
                    <div style="background:white; border-radius:12px; padding:24px; box-shadow:0 2px 4px rgba(0,0,0,0.05); display:flex; gap:20px; align-items:center; max-width:400px; margin: 20px;">
                        <div style="width:80px; height:80px; border-radius:50%; background:#e9ecef; display:flex; align-items:center; justify-content:center; font-size:32px; flex-shrink: 0;">üë§</div>
                        <div>
                            <h4 style="font-size:18px; font-weight:600; margin-bottom:4px; color:#1a365d;">Contact Name</h4>
                            <p style="color:#6c757d; font-size:14px; margin-bottom:12px;">President / Vice President</p>
                            <div style="display:flex; gap:12px;">
                                <a href="tel:+356" style="font-size:20px; text-decoration: none;">üìû</a>
                                <a href="mailto:" style="font-size:20px; text-decoration: none;">‚úâÔ∏è</a>
                                <a href="https://wa.me/" style="font-size:20px; text-decoration: none;">üí¨</a>
                            </div>
                        </div>
                    </div>
                `,
                media: '<svg style="width:48px;height:48px" viewBox="0 0 24 24"><path fill="currentColor" d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>'
            });

            // Announcement Box
            blockManager.add('announcement', {
                label: 'Announcement',
                category: 'KSA Malta',
                content: `
                    <div style="background:#fff3cd; border-left:4px solid #d4a853; padding:20px; border-radius:0 8px 8px 0; margin: 20px 0;">
                        <h4 style="font-size:16px; font-weight:600; color:#1a365d; margin-bottom:8px;">üì¢ Important Announcement</h4>
                        <p style="color:#495057; font-size:14px; line-height: 1.6;">This is an important announcement for all students. Update this text with your message.</p>
                    </div>
                `,
                media: '<svg style="width:48px;height:48px" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>'
            });

            // FAQ Item
            blockManager.add('faq-item', {
                label: 'FAQ Item',
                category: 'KSA Malta',
                content: `
                    <div style="border-bottom:1px solid #e9ecef; padding:20px 0;">
                        <h4 style="font-size:18px; font-weight:600; margin-bottom:12px; color:#1a365d;">‚ùì How do I apply for accommodation?</h4>
                        <p style="color:#495057; font-size:15px; line-height:1.6;">Answer goes here. Provide helpful information for students about the accommodation application process.</p>
                    </div>
                `,
                media: '<svg style="width:48px;height:48px" viewBox="0 0 24 24"><path fill="currentColor" d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z"/></svg>'
            });

            // Two Columns
            blockManager.add('two-columns', {
                label: 'Two Columns',
                category: 'Layout',
                content: `
                    <div style="display:flex; gap:40px; padding:40px 20px; flex-wrap:wrap;">
                        <div style="flex:1; min-width:280px;">
                            <h3 style="font-size:24px; font-weight:600; margin-bottom:16px; color:#1a365d;">Left Column</h3>
                            <p style="color:#495057; line-height:1.6;">Content for the left column goes here. Add text, images, or other elements.</p>
                        </div>
                        <div style="flex:1; min-width:280px;">
                            <h3 style="font-size:24px; font-weight:600; margin-bottom:16px; color:#1a365d;">Right Column</h3>
                            <p style="color:#495057; line-height:1.6;">Content for the right column goes here. Add text, images, or other elements.</p>
                        </div>
                    </div>
                `,
                media: '<svg style="width:48px;height:48px" viewBox="0 0 24 24"><path fill="currentColor" d="M3 3h8v8H3V3zm10 0h8v8h-8V3zM3 13h8v8H3v-8zm10 0h8v8h-8v-8z"/></svg>'
            });

            // Info Box
            blockManager.add('info-box', {
                label: 'Info Box',
                category: 'KSA Malta',
                content: `
                    <div style="background:#e7f3ff; border-left:4px solid #1a365d; padding:20px; border-radius:0 8px 8px 0; margin: 20px 0;">
                        <h4 style="font-size:16px; font-weight:600; color:#1a365d; margin-bottom:8px;">‚ÑπÔ∏è Information</h4>
                        <p style="color:#495057; font-size:14px; line-height: 1.6;">Helpful information or tips for students can go here.</p>
                    </div>
                `,
                media: '<svg style="width:48px;height:48px" viewBox="0 0 24 24"><path fill="currentColor" d="M11 7h2v2h-2zm0 4h2v6h-2zm1-9C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>'
            });
        }

        // Add custom CSS to editor
        function addCustomStyles() {
            // Add base CSS to the canvas
            const css = `
                * {
                    box-sizing: border-box;
                }
                body {
                    margin: 0;
                    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
                    color: #212529;
                    line-height: 1.6;
                }
                a {
                    transition: opacity 0.2s, transform 0.2s;
                }
                a:hover {
                    opacity: 0.9;
                }
            `;
            editor.setStyle(css);
        }

        // Load page data from Firestore
        async function loadPageData() {
            try {
                const doc = await db.collection("pages").doc(pageSlug).get();

                if (doc.exists) {
                    const page = doc.data();
                    document.getElementById('page-title').textContent = page.meta?.title || pageSlug;

                    // Load DRAFT content (not published)
                    if (page.draft) {
                        const draft = page.draft;

                        // Load GrapesJS project data if available
                        if (draft.components) {
                            try {
                                const projectData = JSON.parse(draft.components);
                                editor.loadProjectData(projectData);
                            } catch (error) {
                                console.error('Error parsing components:', error);
                                // Fallback to HTML/CSS
                                if (draft.html) editor.setComponents(draft.html);
                                if (draft.css) editor.setStyle(draft.css);
                            }
                        } else {
                            // Fallback to HTML/CSS
                            if (draft.html) editor.setComponents(draft.html);
                            if (draft.css) editor.setStyle(draft.css);
                        }

                        showNotification('Draft loaded successfully', 'info');
                    } else {
                        showNotification('No draft found. Starting fresh.', 'info');
                    }
                } else {
                    showNotification('Page not found. Please create it from the dashboard.', 'error');
                    setTimeout(() => {
                        window.location.href = '/admin/index.html';
                    }, 2000);
                }
            } catch (error) {
                console.error('Error loading page:', error);
                showNotification('Error loading page: ' + error.message, 'error');
            }
        }

        // Save Draft
        async function saveDraft(silent = false) {
            const html = editor.getHtml();
            const css = editor.getCss();
            const components = JSON.stringify(editor.getProjectData());

            try {
                await db.collection("pages").doc(pageSlug).set({
                    draft: {
                        html: html,
                        css: css,
                        components: components,
                        styles: '',
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedBy: currentUser.email
                    }
                }, { merge: true });

                // Log to audit
                await db.collection("audit_logs").add({
                    action: 'draft_save',
                    pageSlug: pageSlug,
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                if (!silent) {
                    showNotification('Draft saved successfully!', 'success');
                }
            } catch (error) {
                console.error('Error saving draft:', error);
                showNotification('Error: ' + error.message, 'error');
            }
        }

        // Preview Page
        function previewPage() {
            // Save draft first
            saveDraft(true);
            // Open preview in new tab
            window.open('/preview.html?page=' + pageSlug, '_blank');
        }

        // Publish Page
        async function publishPage() {
            if (!confirm('Publish this page to the live site? This will make it visible to all visitors.')) {
                return;
            }

            const note = prompt('Version note (optional):', 'Published from editor');

            const html = editor.getHtml();
            const css = editor.getCss();
            const components = JSON.stringify(editor.getProjectData());
            const versionId = Date.now().toString();

            try {
                const batch = db.batch();

                // 1. Create version snapshot
                const versionRef = db.collection("pages").doc(pageSlug)
                    .collection("versions").doc(versionId);
                batch.set(versionRef, {
                    html: html,
                    css: css,
                    components: components,
                    styles: '',
                    note: note || '',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser.email
                });

                // 2. Update published content
                const pageRef = db.collection("pages").doc(pageSlug);
                batch.set(pageRef, {
                    published: {
                        html: html,
                        css: css,
                        publishedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        publishedBy: currentUser.email,
                        versionId: versionId
                    },
                    'meta.lastPublishedAt': firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                await batch.commit();

                // 3. Log to audit
                await db.collection("audit_logs").add({
                    action: 'publish',
                    pageSlug: pageSlug,
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    versionId: versionId,
                    note: note,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                showNotification('Published successfully! üöÄ', 'success');

                // Reload version history
                setTimeout(() => {
                    loadVersionHistory();
                }, 1000);

            } catch (error) {
                console.error('Error publishing:', error);
                showNotification('Error: ' + error.message, 'error');
            }
        }

        // Load Version History
        async function loadVersionHistory() {
            const versionsDiv = document.getElementById('version-history');
            versionsDiv.innerHTML = '<p style="font-size: 13px; color: #6c757d;">Loading...</p>';

            try {
                const snapshot = await db.collection("pages").doc(pageSlug)
                    .collection("versions")
                    .orderBy("createdAt", "desc")
                    .limit(20)
                    .get();

                if (snapshot.empty) {
                    versionsDiv.innerHTML = '<p style="font-size: 13px; color: #6c757d;">No versions yet</p>';
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const v = doc.data();
                    const date = v.createdAt?.toDate().toLocaleString() || 'Unknown';
                    html += `
                        <div class="version-item">
                            <div class="version-date">${date}</div>
                            <div class="version-by">${v.createdBy || 'Unknown'}</div>
                            ${v.note ? `<div class="version-note">"${v.note}"</div>` : ''}
                            <button class="btn-restore" onclick="restoreVersion('${doc.id}')">Restore This Version</button>
                        </div>
                    `;
                });
                versionsDiv.innerHTML = html;

            } catch (error) {
                console.error('Error loading versions:', error);
                versionsDiv.innerHTML = '<p style="font-size: 13px; color: #dc3545;">Error loading versions</p>';
            }
        }

        // Restore Version
        async function restoreVersion(versionId) {
            if (!confirm('Restore this version? Your current draft will be overwritten.')) {
                return;
            }

            try {
                const doc = await db.collection("pages").doc(pageSlug)
                    .collection("versions").doc(versionId).get();

                if (!doc.exists) {
                    showNotification('Version not found', 'error');
                    return;
                }

                const v = doc.data();

                // Load into editor
                if (v.components) {
                    try {
                        const projectData = JSON.parse(v.components);
                        editor.loadProjectData(projectData);
                    } catch (error) {
                        console.error('Error parsing components:', error);
                        editor.setComponents(v.html);
                        editor.setStyle(v.css);
                    }
                } else {
                    editor.setComponents(v.html);
                    editor.setStyle(v.css);
                }

                // Save as new draft
                await db.collection("pages").doc(pageSlug).set({
                    draft: {
                        html: v.html,
                        css: v.css,
                        components: v.components || '',
                        styles: v.styles || '',
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedBy: currentUser.email
                    }
                }, { merge: true });

                // Log rollback
                await db.collection("audit_logs").add({
                    action: 'rollback',
                    pageSlug: pageSlug,
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    restoredVersionId: versionId,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                showNotification('Version restored successfully!', 'success');

            } catch (error) {
                console.error('Error restoring version:', error);
                showNotification('Error: ' + error.message, 'error');
            }
        }

        // Notification helper
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification ' + type;
            notification.style.display = 'block';

            setTimeout(() => {
                notification.style.display = 'none';
            }, 4000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + S: Save Draft
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveDraft();
            }
            // Ctrl/Cmd + P: Preview
            if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                e.preventDefault();
                previewPage();
            }
        });

        // Warn before leaving with unsaved changes
        window.addEventListener('beforeunload', (e) => {
            // Check if there are unsaved changes
            const changesCount = editor ? editor.getDirtyCount() : 0;
            if (changesCount > 0) {
                e.preventDefault();
                e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
                return e.returnValue;
            }
        });
    </script>
</body>
</html>
